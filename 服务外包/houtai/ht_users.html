<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>会议室管理中心</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="shortcut icon" href="favicon_16.ico"/>
    <!-- <link rel="bookmark" href="favicon_16.ico"/> -->
    <!-- site css -->
    <link rel="stylesheet" href="layui/css/layui.css"  media="all">
    <link rel="stylesheet" href="dist/css/site.min.css">
    <link rel="stylesheet" href="dist/css/me.css">
    <script src="layui/layui.js" charset="utf-8" type="text/javascript"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements. All other JS at the end of file. -->
    <!--[if lt IE 9]>
    <script src="js/html5shiv.js"></script>
    <script src="js/respond.min.js"></script>
    <![endif]-->
    <script type="text/javascript" src="dist/js/site.min.js"></script>
    <script type="text/javascript" src="dist/js/houtai.js"></script>
    <script src="dist/js/vue.min.js"></script>
</head>
<body>
<!-- 顶部导航 -->
<div class="headerpage"></div>
<!--顶部导航 over-->

<!--添加user，弹出框-->
<div id="mz_add_info" style="display: none;margin: 10px 70px 0 0px">
    <form class="layui-form me_margin_top" id="user_add" action="" lay-filter="addForm">
        <div class="layui-form-item">
            <label class="layui-form-label">用户名</label>
            <div class="layui-input-block">
                <input type="text" name="name" id="name" required  lay-verify="name" placeholder="请输入用户名" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">手机号</label>
            <div class="layui-input-block">
                <input type="text" name="phone" id="phone" required lay-verify="required" placeholder="请输入手机号" autocomplete="off" class="layui-input">
            </div>
            <!--<div class="layui-form-mid layui-word-aux">登陆使用</div>-->
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">密码</label>
            <div class="layui-input-block">
                <input type="password" name="psw" id="psw" required  lay-verify="psw" placeholder="请输入密码" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">邮箱</label>
            <div class="layui-input-block">
                <input type="text" name="email" id="email" required  lay-verify="required" placeholder="请输入邮箱" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">公司</label>
            <div class="layui-input-block">
                <select name="companyCode" id="companyCode"  class="add_company" lay-verify="required">
                    <option value=""></option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">权限</label>
            <div class="layui-input-block">
                <select name="role" lay-verify="required">
                    <option value=""></option>
                    <option value="1">普通用户</option>
                    <option value="2">HR</option>
                    <option value="3">后勤</option>
                    <option value="4">管理员</option>
                </select>
            </div>
        </div>
    </form>
</div>

<!--修改user，弹出框-->
<div id="mz_edit_info" style="display: none;margin: 10px 70px 0 0px">
    <form class="layui-form me_margin_top" id="user_edit" action="" lay-filter="editForm">
        <div class="layui-form-item">
            <label class="layui-form-label">用户名</label>
            <div class="layui-input-block">
                <input type="text" name="name" required  lay-verify="required" placeholder="请输入用户名" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">手机号</label>
            <div class="layui-input-block">
                <input type="text" name="phone" required lay-verify="required" placeholder="请输入手机号" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">密码</label>
            <div class="layui-input-block">
                <input type="password" name="password" if="psw1" required  lay-verify="psw" placeholder="***" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">邮箱</label>
            <div class="layui-input-block">
                <input type="text" name="email" required  lay-verify="required" placeholder="请输入用户名" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">权限</label>
            <div class="layui-input-block">
                <select name="role" lay-verify="required" lay-search>
                    <option value=""></option>
                    <option value="1">普通用户</option>
                    <option value="2">HR</option>
                    <option value="3">后勤</option>
                    <option value="4">管理员</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">公司</label>
            <div class="layui-input-block">
                <select name="companyId" class="edit_company" id="companyId" lay-verify="required">
                    <option value=""></option>
                </select>
            </div>
        </div>
    </form>
</div>


<div class="container-fluid">
    <!--documents内容-->
    <div class="row row-offcanvas row-offcanvas-left">
        <!--内容左边导航-->
        <div class="col-xs-6 col-sm-3 sidebar-offcanvas" role="navigation">
            <ul class="list-group panel">
                <li class="list-group-item"><i class="glyphicon glyphicon-align-justify"></i> <b>功能</b></li>
                <li class="list-group-item"><input type="text" class="form-control search-query" placeholder="查找功能"></li>
                <li class="active">
                    <a href="ht_index.html" class="list-group-item"><i class="glyphicon glyphicon-home"></i>主界面 </a>
                </li>
                <li>
                    <a href="#xitong" class="list-group-item  main_item1" data-toggle="collapse">
                        <i class="glyphicon glyphicon-cog"></i>系统管理
                        <span class="glyphicon glyphicon-chevron-right"></span>
                    </a>
                    <div class="collapse sys_item" id="xitong">
                        <a href="ht_account.html" class="list-group-item">账号管理</a>
                        <a href="ht_company.html" class="list-group-item">雇主信息</a>
                        <a href="ht_notice.html" class="list-group-item">公告管理</a>
                    </div>
                </li>

                <li>
                    <a href="#huiyi" class="list-group-item main_item2 " data-toggle="collapse">
                        <i class="glyphicon glyphicon-calendar"></i>会议管理
                        <span class="glyphicon glyphicon-chevron-right"></span>
                    </a>
                    <div class="collapse meet_item layui-anim layui-anim-upbit" id="huiyi">
                        <a href="ht_shenhe.html" class="list-group-item">会议审核</a>
                        <a href="ht_meet.html" class="list-group-item">会议室管理</a>
                        <a href="ht_tag.html" class="list-group-item">会议室标签</a>
                    </div>
                </li>
                <li>
                    <a href="ht_users.html" class="list-group-item">
                        <i class="glyphicon glyphicon-user"></i>成员管理
                    </a>
                </li>
                <li>
                    <a href="ht_service.html" class="list-group-item">
                        <i class="glyphicon glyphicon-flash"></i>客户服务
                    </a>
                </li>
                <li>
                    <a href="#" class="list-group-item">
                        <i class="glyphicon glyphicon-bell"></i>今日详情
                    </a>
                </li>
                <li>
                    <a href="#" class="list-group-item">
                        <i class="glyphicon glyphicon-indent-left"></i>查询分析
                    </a>
                </li>
            </ul>
        </div>

        <!--右边内容-->
        <div class="col-xs-12 col-sm-9 content">
            <div class="panel panel-default">
                <!--内容上面标题部分-->
                <div class="panel-heading">
                    <h3 class="panel-title"><a href="javascript:void(0);" class="toggle-sidebar"><span class="fa fa-angle-double-left" data-toggle="offcanvas" title="Maximize Panel"></span></a> 用户管理</h3>
                    <!--<a href="#">刷新</a>-->
                </div>
                <div class="panel-body">
                    <div class="content-row">
                        <div class="col-md-12">
                            <!-- table-model -->
                            <div class="searchTable" id="app_search"><!--搜索-->
                                按{{way}}搜索：
                                <div class="layui-inline">
                                    <input class="layui-input" name="id" id="searchReload" autocomplete="off">
                                </div>
                                <div class="search_way">
                                    搜索方式：
                                    <select name="city" id="choice_way" lay-verify="required" @change="change">
                                        <option value="name">按用户名</option>
                                        <option value="phone">按手机号</option>
                                        <option value="email">按邮箱</option>
                                        <option value="company">按公司</option>
                                    </select>
                                </div>
                                <button class="layui-btn" data-type="reload">搜索</button>
                                <button class="layui-btn me_fr" id="mz_add_meet">添加员工</button>
                                <!--<button class="layui-btn me_fr" id="mz_add_meet" data-toggle="modal" data-target="#tableModal">添加会议室</button>-->
                            </div>
                            <table class="layui-hide" id="mz_user_table" lay-filter="mz_user_table"></table>
                            <div id="laypage_user"></div>
                            <script type="text/html" id="toolbarMeet">
                                <div class="layui-btn-container">
                                    <button class="layui-btn layui-btn-sm" lay-event="getCheckData">获取选中行数据</button>
                                    <button class="layui-btn layui-btn-sm" lay-event="getCheckLength">获取选中数目</button>
                                    <button class="layui-btn layui-btn-sm" lay-event="isAll">验证是否全选</button>
                                    <button class="layui-btn layui-btn-sm" lay-event="addTable">添加</button>
                                </div>
                            </script>
                            <script type="text/html" id="barMeet">
                                <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
                                <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
                            </script>
                            <script type="text/html" id="barA"></script>
                        </div>
                    </div>
                </div><!-- panel body -->
            </div>
        </div><!-- content -->
    </div>
</div>


<!--footer-->
<div class="footerpage"></div>
<!--footer over-->


<img id="showimg" style="width: 150px;height: 150px;"><!--user头像-->
<script type="text/html" id="trole"><!--权限-->
    {{#  if(d.role == 1){ }}
        <p>普通用户</p>
    {{#  } else if(d.role == 2) { }}
        <p>HR</p>
    {{#  } else if(d.role == 3) { }}
        <p>后勤</p>
    {{#  } else if(d.role == 4) { }}
        <p>管理员</p>
    {{#  } }}
</script>

<script type="text/html" id="tcompany"><!--公司-->
    {{#  if(d.company == null){ }}
        <p>空</p>
    {{#  } else { }}
        <p>{{d.company.name}}</p>
    {{#  } }}
</script>


<script>
    $(".headerpage").load("./page/header.html");
    $(".footerpage").load("./page/footer.html");

    //搜索
    var vm = new Vue({
        el: '#app_search',
        data:{
            way: '用户名',
            v: 0
        },
        methods:{
            change(select){  //搜索方式改变
                this.v = select.target.value;
                if(this.v=="name"){ this.way='用户名'}
                if(this.v=="phone") { this.way = '手机号'}
                if(this.v=="email") { this.way = '邮箱'}
                if(this.v=="company") { this.way = '公司'}
            }
        }
    });

    //点击事件显示头像
    function show_img(src){
        var img =  $('#showimg');
        if(src=="default.jpg"){
           img.attr("src", "dist/img/bg2.jpg");
        } else{
            img.attr("src", src);
        }
        layer.open({
            type: 1
            ,title: false//不显示标题栏
            ,id: 'LAY_layuimg000000' //设定一个id，防止重复弹出
            ,btnAlign: 'c'
            ,content: $('#showimg')
        });
    }

    // layui.use('form',function () {
    //     var form = layui.form;
    //     form.verify({
    //         name: function(value, item){ //value：表单的值、item：表单的DOM对象
    //             if(!new RegExp("^[a-zA-Z0-9_\u4e00-\u9fa5\\s·]+$").test(value)){
    //                 return '用户名不能有特殊字符';
    //             }
    //             if(/(^\_)|(\__)|(\_+$)/.test(value)){
    //                 return '用户名首尾不能出现下划线\'_\'';
    //             }
    //         }
    //         ,psw: [
    //             /^[\S]{6,12}$/
    //             ,'密码必须6到12位，且不能出现空格'
    //         ]
    //     });
    // });


    function getCompany(company){  //获取公司信息
        $.ajax({
            url:"http://lsudjh.top:8081/company/listEntity",
            type:"POST",
            data:'{}',
            contentType:"application/json",  //缺失会出现URL编码，无法转成json对象
            success:function(result){ //所有错误信息都如result.message有关
                if(result.code==0){
                    layui.use('form', function(){
                        var form = layui.form;

                        company.empty();
                        company.append("<option value=''></option>" );
                        for(var i=0; i<result.data.data.length; i++) {
                            // console.log(result.data.data[i])
                            company.append("<option value=\"" +result.data.data[i].id+"\">" + result.data.data[i].name + "");
                        }
                        form.render('select');
                    });
                }
            }
        });
    }
    function getCompanyCode (company){  //获取公司code
        $.ajax({
            url:"http://lsudjh.top:8081/company/listEntity",
            type:"POST",
            data:'{}',
            contentType:"application/json",  //缺失会出现URL编码，无法转成json对象
            success:function(result){ //所有错误信息都如result.message有关
                if(result.code==0){
                    layui.use('form', function(){
                        var form = layui.form;

                        company.empty();
                        company.append("<option value=''></option>" );
                        for(var i=0; i<result.data.data.length; i++) {
                            // console.log(result.data.data[i])
                            company.append("<option value=\"" +result.data.data[i].code+"\">" + result.data.data[i].name + "");
                        }
                        form.render('select');
                    });
                }
            }
        });
    }

    //数据表格
    var curnum = 1;
    var size = 10;
    function user_search(curnum,size){
        layui.use(['table','laypage'], function(){
            var table = layui.table;
            var laypage = layui.laypage;

            table.render({
                elem: '#mz_user_table'
                ,url:'http://lsudjh.top:8081/user/listEntity'
                ,toolbar: '#toolbarMeet'
                ,title: '用户数据表'
                ,id:'user_table'
                ,contentType: 'application/json'
                ,method: 'post'
                ,cols: [[
                    {type: 'checkbox', fixed: 'left'}
                    ,{field:'id', title:'ID', width:80, fixed: 'left', unresize: true, sort: true}
                    ,{field:'name', title:'用户名', width:150}
                    ,{field:'phone', title:'手机号', width:150}
                    ,{field:'email', title:'邮箱', width:200}
                    ,{field:'avatar', title:'头像', width:80,
                        templet: '<div><a onclick=show_img("{{d.avatar}}") class="layui-table-link">查看</a></div>'}
                    ,{field:'company', title:'公司部门',width:120, templet:'#tcompany'}
                    ,{field:'role', title:'权限',width:120, templet: '#trole'}
                    ,{fixed: 'right', title:'操作', toolbar: '#barMeet', width:150}
                ]]
                ,page: false
                ,where: {size:size, page:curnum,order :'id asc'}
                ,parseData: function(res){ //res 即为原始返回的数据
                    console.log(res);
                    return {
                        "code": res.code, //解析接口状态
                        "msg": res.message, //解析提示文本
                        "count": res.data.total, //解析数据长度
                        "data": res.data.data //解析数据列表
                    };
                }
                ,done: function(res, curr, count){
                    //如果是异步请求数据方式，res即为你接口返回的信息。
                    //如果是直接赋值的方式，res即为：{data: [], count: 99} data为当前页数据、count为数据总长度
                    laypage.render({
                        elem:'laypage_user'
                        ,count:count
                        ,curr:curnum
                        ,limit:size
                        ,layout: ['prev', 'page', 'next', 'skip','count','limit', 'refresh']
                        ,jump:function (obj,first) {
                            if(!first){
                                curnum = obj.curr;
                                size = obj.limit;
                                user_search(curnum,size);
                                // table.reload('user_table', {
                                //
                                //     where:{
                                //         size: obj.limit
                                //         ,page: obj.curr
                                //     }
                                // });
                            }
                        }
                    })
                }
            });

            table.on('toolbar(mz_user_table)', function(obj){
                var checkStatus = table.checkStatus(obj.config.id);
                switch(obj.event){
                    case 'getCheckData':
                        var data = checkStatus.data;
                        layer.alert(JSON.stringify(data));
                        break;
                    case 'getCheckLength':
                        var data = checkStatus.data;
                        layer.msg('选中了：'+ data.length + ' 个');
                        break;
                    case 'isAll':
                        layer.msg(checkStatus.isAll ? '全选': '未全选');
                        break;
                };
            });

            //监听行工具事件
            table.on('tool(mz_user_table)', function(obj){
                var data = obj.data;  //获得当前行数据
                // console.log(data)
                var e = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
                var tr = obj.tr; //获得当前行 tr 的DOM对象

                if(e === 'del'){    //table行删除事件
                    layer.confirm('真的删除行么', function(index){
                        var tdata = {
                            id: data.id
                        };
                        $.ajax({
                            url:"http://lsudjh.top:8081/user/delete",
                            type:"POST",
                            data:JSON.stringify(tdata),
                            contentType:"application/json",  //缺失会出现URL编码，无法转成json对象
                            success:function(result){ //所有错误信息都如result.message有关
                                alert(result.msg);
                                obj.del();   //删除对应行（tr）的DOM结构，并更新缓存
                                layer.close(index);//关闭弹出框
                            }
                        });
                    });
                } else if(e === 'edit'){    //table行编辑事件
                    var company = $('.edit_company');
                    getCompany(company);

                    layui.use('form', function(){
                        var form = layui.form;
                        form.val("editForm", data);
                    });
                    layer.open({
                        type: 1
                        ,title: "编辑信息" //不显示标题栏
                        // ,closeBtn: true
                        ,area: '400px'
                        ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
                        ,btn: ['确定', '取消']
                        ,btnAlign: 'c'
                        ,moveType: 1 //拖拽模式，0或者1
                        ,content: $('#mz_edit_info')
                        ,yes:function (index, layero) {
                            console.log(JSON.stringify($('form[id="user_edit"]').serializeObject()));
                            var tdata = $('form[id="user_edit"]').serializeObject();
                            tdata.id = data.id;
                            console.log(tdata.id)
                            $.ajax({
                                url:"http://lsudjh.top:8081/user/update",
                                type:"POST",
                                data:JSON.stringify(tdata),
                                contentType:"application/json",  //缺失会出现URL编码，无法转成json对象
                                success:function(result){ //所有错误信息都如result.message有关
                                    alert(result.msg);

                                    if(result.code==0){
                                        $('#user_edit')[0].reset();
                                        layer.close(index);  //关闭弹出层
                                        // table.reload('user_table', {
                                        //     where:{
                                        //
                                        //     }
                                        // });
                                        user_search(curnum,size);
                                    } else{
                                        // console.log($('#user_add'));
                                        // $('#user_edit')[0].reset();   //[0]必须得加
                                        console.log(data);
                                        layui.use('form', function(){
                                            var form = layui.form;
                                            data.password = '';
                                            form.val("editForm", data);
                                        });
                                    }

                                }
                            });
                        }
                        ,btn2:function (index, layero) {

                        }
                    });
                }
            });

            //搜索重载
            var $ = layui.$, active = {
                reload: function(){
                    var searchReload = $('#searchReload');

                    //执行重载
                    var key = $('#searchReload').val();
                    var way = $('#choice_way').val();
                    var tdata = {};
                    if(way=="name"){
                        tdata.name = key;
                    } else if(way=="phone"){
                        tdata.phone = key;
                    } else if(way=="email"){
                        tdata.phone = key;
                    } else if(way=="company"){
                        tdata.company = key;
                    }
                    tdata.order = 'id asc';
                    console.log(tdata);
                    table.reload('user_table', {
                        where: tdata
                    });
                }
            };

            $('.searchTable .layui-btn').on('click', function(){
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
        });
    }
    user_search(curnum,size);

    //添加user
    $('#mz_add_meet').on("click", function () {

        //渲染user_add的公司下拉框
        var company = $('.add_company');
        getCompanyCode(company);

        layer.open({
            type: 1
            ,title: "添加员工（手机号为登录账号）" //不显示标题栏
            ,area: '400px'
            ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
            ,btn: ['确定', '取消']
            ,btnAlign: 'c'
            ,moveType: 1 //拖拽模式，0或者1
            ,content: $('#mz_add_info')
            ,yes:function (index, layero) {
                // console.log(layero.html());
                // console.log($('form').html());
                var tdata = $('form[id="user_add"]').serializeObject();
                var psw = $('#psw').val();
                if(psw!=""&&psw!=null){
                    tdata.password = psw;
                }else{
                    tdata.password = null;
                }
                console.log(tdata);
                $.ajax({
                    url:"http://lsudjh.top:8081/user/register",
                    type:"POST",
                    data:JSON.stringify(tdata),
                    contentType:"application/json",  //缺失会出现URL编码，无法转成json对象
                    success:function(result){ //所有错误信息都如result.message有关
                        alert(result.msg);

                        if(result.code==0){
                            $('#user_add')[0].reset();
                            layer.close(index);  //关闭弹出层
                            layui.use('table', function() {
                                var table = layui.table;
                                // table.reload('user_table', {
                                // });
                                user_search(curnum,size);
                            });
                        } else{
                            // console.log($('#user_add'));
                            // $('#user_add')[0].reset();   //[0]必须得加
                        }

                    }
                });
            }
            ,btn2:function (index, layero) {
                $('#user_add')[0].reset();   //[0]必须得加，清楚已填数据
            }
        });
    });

    /**
     * 自动将form表单封装成json对象
     */
    $.fn.serializeObject = function() {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function() {
            if (o[this.name]) {
                if (!o[this.name].push) {
                    o[this.name] = [ o[this.name] ];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    };
</script>
</body>
</html>
